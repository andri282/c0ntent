<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Konten</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div class="container">
        <div class="header">
            <div>
                <h1>ðŸš€ Dashboard Konten</h1>
                <p id="progress-info">Memuat data...</p>
            </div>
            <a href="add.html" class="btn-add">+ Tambah Konten</a>
        </div>

        <div class="table-wrap">
            <table>
                <thead>
                    <tr>
                        <th width="5%">No</th>
                        <th width="25%">Task Name</th>
                        <th width="12%">Category</th>
                        <th width="10%">Priority</th>
                        <th width="12%">Due Date</th>
                        <th width="12%">Days Left</th>
                        <th width="15%">Status</th>
                        <th width="5%" style="text-align:center">Done</th>
                    </tr>
                </thead>
                <tbody id="task-list">
                    <tr><td colspan="8" style="text-align:center; padding:20px">Sedang mengambil data...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // GANTI DENGAN URL APPS SCRIPT BARU LO
        const API_URL = "https://script.google.com/macros/s/AKfycbzUuN3e88CYwvlRYNGLsYsDxFXxFHC0ZyWE4vPenzkn9927tetWD2K1c52XBp0X9FD3zg/exec"; 

        async function fetchData() {
            try {
                const res = await fetch(`${API_URL}?action=read`);
                const json = await res.json();
                renderTable(json.data);
                updateStats(json.data);
            } catch (err) { console.error(err); }
        }

        function renderTable(tasks) {
            const tbody = document.getElementById('task-list');
            tbody.innerHTML = "";
            
            // Urutkan biar yang belum selesai ada di atas (Opsional)
            // tasks.sort((a, b) => a.done - b.done);

            tasks.forEach(task => {
                if (!task.no) return; 

                const isFinished = (task.status === 'Published' || task.done === true);
                const due = new Date(task.duedate);
                const today = new Date(); due.setHours(0,0,0,0); today.setHours(0,0,0,0);
                const diffDays = Math.ceil((due - today) / (1000 * 60 * 60 * 24));
                
                let daysText = diffDays < 0 ? `Telat ${Math.abs(diffDays)} hari` : `${diffDays} hari lagi`;
                let daysClass = diffDays < 0 ? "days-late" : "";
                
                if (diffDays === 0) { daysText = "HARI INI!"; daysClass = "days-late"; }
                if (isFinished) { daysText = "Selesai âœ…"; daysClass = "days-done"; }

                let catClass = 'cat-brainstorm';
                if(task.category.includes('Gadget')) catClass = 'cat-gadget';
                if(task.category.includes('Vlog')) catClass = 'cat-vlog';
                if(task.category.includes('Shorts')) catClass = 'cat-shorts';

                let prioClass = task.priority === 'High' ? 'prio-high' : (task.priority === 'Medium' ? 'prio-medium' : 'prio-low');

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>#${task.no}</td>
                    <td style="font-weight:500">${task.task}</td>
                    <td><span class="badge ${catClass}">${task.category}</span></td>
                    <td><span class="${prioClass}">${task.priority}</span></td>
                    <td>${new Date(task.duedate).toLocaleDateString('id-ID')}</td>
                    <td><span id="days-${task.no}" class="${daysClass}">${daysText}</span></td>
                    <td>
                        <select onchange="handleStatus(${task.no}, this.value)">
                            <option value="Not Started" ${task.status === 'Not Started' ? 'selected' : ''}>Not Started</option>
                            <option value="Research" ${task.status === 'Research' ? 'selected' : ''}>Research</option>
                            <option value="Scripting" ${task.status === 'Scripting' ? 'selected' : ''}>Scripting</option>
                            <option value="Scheduling" ${task.status === 'Scheduling' ? 'selected' : ''}>Scheduling</option>
                            <option value="Published" ${task.status === 'Published' ? 'selected' : ''}>Published</option>
                        </select>
                    </td>
                    <td style="text-align:center">
                        <input type="checkbox" id="check-${task.no}" ${task.done === true ? 'checked' : ''} onchange="updateData(${task.no}, 'done', this.checked)">
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function handleStatus(id, status) {
            updateData(id, 'status', status);
            if(status === 'Published') {
                document.getElementById(`check-${id}`).checked = true;
                document.getElementById(`days-${id}`).className = "days-done";
                document.getElementById(`days-${id}`).innerText = "Selesai âœ…";
                updateData(id, 'done', true);
            }
        }

        function updateData(id, type, val) {
            fetch(`${API_URL}?action=update&no=${id}&${type}=${val}`, { method: 'POST' });
        }

        function updateStats(tasks) {
            const done = tasks.filter(t => t.done === true).length;
            document.getElementById('progress-info').innerHTML = `Progress: <b>${done}</b> selesai.`;
        }

        fetchData();
    </script>
</body>
</html>