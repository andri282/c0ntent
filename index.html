<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>To Do Activity</title>
    <style>
      :root {
        --primary: #2563eb;
        --bg: #f3f4f6;
        --card: #ffffff;
        --text: #1f2937;
        --border: #e5e7eb;
        --success: #16a34a;
        --danger: #dc2626;
      }
      body {
        font-family: "Segoe UI", sans-serif;
        background: var(--bg);
        color: var(--text);
        margin: 0;
        padding: 20px;
      }

      /* --- LOGIN SCREEN STYLE --- */
      #login-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: var(--bg);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
      }
      .login-card {
        background: white;
        padding: 40px;
        border-radius: 12px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        width: 100%;
        max-width: 350px;
        text-align: center;
      }
      .login-card h2 {
        margin-top: 0;
        color: var(--primary);
      }
      .login-card input {
        width: 100%;
        padding: 12px;
        margin-bottom: 15px;
        border: 1px solid #ddd;
        border-radius: 8px;
        box-sizing: border-box;
        font-size: 1rem;
      }
      .btn-login {
        background: var(--primary);
        color: white;
        width: 100%;
        padding: 12px;
        border: none;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
        font-size: 1rem;
      }
      .btn-login:hover {
        background: #1d4ed8;
      }

      /* --- DASHBOARD STYLE (UI GANTENG) --- */
      #dashboard-screen {
        display: none;
      }

      .header {
        background: var(--primary);
        color: white;
        padding: 1.5rem;
        border-radius: 12px;
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      }
      .header h1 {
        margin: 0;
        font-size: 1.5rem;
      }
      .user-badge {
        background: rgba(255, 255, 255, 0.2);
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.9rem;
        margin-left: 10px;
        font-weight: bold;
      }

      .btn-group {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .btn-add {
        background: white;
        color: var(--primary);
        padding: 10px 20px;
        text-decoration: none;
        border-radius: 8px;
        font-weight: 700;
        cursor: pointer;
        border: none;
        transition: 0.2s;
      }
      .btn-add:hover {
        background: #eff6ff;
        transform: translateY(-1px);
      }
      .btn-logout {
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.5);
        color: white;
        padding: 9px 15px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: 0.2s;
      }
      .btn-logout:hover {
        background: rgba(255, 255, 255, 0.1);
        border-color: white;
      }

      /* TABEL STYLE (LEGA & RAPI) */
      .table-wrap {
        overflow-x: auto;
        background: var(--card);
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }
      table {
        width: 100%;
        border-collapse: collapse;
        min-width: 1100px;
      } /* Lebar min digedein biar lega */
      th {
        background: #f8fafc;
        text-align: left;
        padding: 16px;
        border-bottom: 2px solid var(--border);
        font-weight: 600;
        color: #64748b;
      }
      td {
        padding: 14px 16px;
        border-bottom: 1px solid var(--border);
        vertical-align: middle;
        font-size: 0.95rem;
      }
      tr:hover {
        background-color: #f8fafc;
      }

      /* BADGES */
      .badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        display: inline-block;
        white-space: nowrap;
      }
      .cat-gadget {
        background: #dbeafe;
        color: #1e40af;
      }
      .cat-vlog {
        background: #fef9c3;
        color: #854d0e;
      }
      .cat-shorts {
        background: #fee2e2;
        color: #991b1b;
      }
      .cat-brainstorm {
        background: #d1fae5;
        color: #065f46;
      }
      .cat-default {
        background: #f3f4f6;
        color: #4b5563;
      }

      /* PRIORITY COLORS */
      .prio-high {
        color: var(--danger);
        font-weight: 700;
      }
      .prio-medium {
        color: #d97706;
        font-weight: 600;
      }
      .prio-low {
        color: var(--success);
        font-weight: 600;
      }

      /* DAYS LEFT STYLE */
      .days-ok {
        color: #4b5563;
        font-weight: 500;
      }
      .days-today {
        color: #ea580c;
        font-weight: 800;
      }
      .days-late {
        color: var(--danger);
        font-weight: 800;
        background: #fee2e2;
        padding: 4px 8px;
        border-radius: 6px;
        white-space: nowrap;
      }
      .days-done {
        color: var(--success);
        font-weight: 700;
        background: #dcfce7;
        padding: 4px 10px;
        border-radius: 6px;
        white-space: nowrap;
        border: 1px solid #bbf7d0;
      }

      select {
        padding: 8px;
        border: 1px solid var(--border);
        border-radius: 6px;
        background: white;
        font-size: 0.9rem;
        cursor: pointer;
      }
      input[type="checkbox"] {
        width: 20px;
        height: 20px;
        cursor: pointer;
        accent-color: var(--success);
      }

      /* ACTION BUTTONS */
      .btn-action {
        padding: 6px 10px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        margin-right: 5px;
      }
      .btn-edit {
        background: #f3f4f6;
        border: 1px solid #d1d5db;
        color: #374151;
      }
      .btn-edit:hover {
        background: #e5e7eb;
      }
      .btn-delete {
        background: #fee2e2;
        color: var(--danger);
        border: 1px solid #fca5a5;
      }
      .btn-delete:hover {
        background: #fecaca;
      }

      /* MODAL STYLE */
      .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }
      .modal-card {
        background: white;
        padding: 30px;
        border-radius: 12px;
        width: 100%;
        max-width: 400px;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
      }
      .form-group {
        margin-bottom: 15px;
      }
      .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        color: #374151;
      }
      .form-control {
        width: 100%;
        padding: 10px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        box-sizing: border-box;
        font-size: 1rem;
      }
      .btn-submit {
        background: var(--primary);
        color: white;
        width: 100%;
        padding: 12px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
      }
      .btn-cancel {
        background: transparent;
        width: 100%;
        padding: 10px;
        border: none;
        cursor: pointer;
        color: #6b7280;
        margin-top: 5px;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: #6b7280;
        font-style: italic;
      }
    </style>
  </head>
  <body>
    <div id="login-screen">
      <div class="login-card">
        <h2>üîê To Do Activity</h2>
        <p style="color: #666; font-size: 0.9rem; margin-bottom: 20px">Masukkan Nama & PIN Anda</p>
        <input type="text" id="login-user" placeholder="Username (misal: Andri)" required />
        <input type="password" id="login-pin" placeholder="PIN (misal: 1234)" required />
        <button class="btn-login" onclick="doLogin()">Masuk</button>
        <p id="login-msg" style="color: red; margin-top: 10px; font-size: 0.9rem"></p>
      </div>
    </div>

    <div id="dashboard-screen">
      <div class="header">
        <div>
          <h1>üöÄ Dashboard <span id="display-user" class="user-badge"></span></h1>
          <p id="progress-info">Memuat data...</p>
        </div>
        <div class="btn-group">
          <a href="add.html" class="btn-add">+ Tambah Konten</a>
          <button class="btn-logout" onclick="doLogout()">Keluar</button>
        </div>
      </div>

      <div class="table-wrap">
        <table id="main-table">
          <thead>
            <tr>
              <th width="5%">No</th>
              <th width="20%">Task Name</th>
              <th width="12%">Category</th>
              <th width="10%">Priority</th>
              <th width="12%">Due Date</th>
              <th width="12%">Days Left</th>
              <th width="12%">Status</th>
              <th width="5%" style="text-align: center">Done</th>
              <th width="10%" style="text-align: center">Aksi</th>
            </tr>
          </thead>
          <tbody id="task-list">
            <tr>
              <td colspan="9" class="loading">Sedang mengambil data...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="modal-overlay" id="editModal">
      <div class="modal-card">
        <h3 style="margin-top: 0">‚úèÔ∏è Edit Konten</h3>
        <form id="editForm">
          <input type="hidden" id="edit-id" />
          <div class="form-group">
            <label>Judul Task</label>
            <input type="text" id="edit-task" class="form-control" placeholder="Judul" required />
          </div>
          <div class="form-group">
            <label>Kategori</label>
            <select id="edit-category" class="form-control">
              <option value="YT Gadget">YT Gadget</option>
              <option value="YT Vlog">YT Vlog</option>
              <option value="Shorts">Shorts</option>
              <option value="Brainstorm">Brainstorm</option>
            </select>
          </div>
          <div class="form-group">
            <label>Prioritas</label>
            <select id="edit-priority" class="form-control">
              <option value="High">High üî•</option>
              <option value="Medium">Medium ‚ö†Ô∏è</option>
              <option value="Low">Low ‚òòÔ∏è</option>
            </select>
          </div>
          <div class="form-group">
            <label>Due Date</label>
            <input type="date" id="edit-duedate" class="form-control" required />
          </div>
          <button type="submit" class="btn-submit" id="btnSaveEdit">Simpan Perubahan</button>
          <button type="button" class="btn-cancel" onclick="document.getElementById('editModal').style.display='none'">Batal</button>
        </form>
      </div>
    </div>

    <script>
      // MASUKKAN URL DEPLOYMENT APPS SCRIPT DI SINI
      const API_URL = "https://script.google.com/macros/s/AKfycbzUuN3e88CYwvlRYNGLsYsDxFXxFHC0ZyWE4vPenzkn9927tetWD2K1c52XBp0X9FD3zg/exec";

      let CURRENT_USER = localStorage.getItem("planner_user") || null;
      let globalTasks = [];

      // --- SISTEM LOGIN ---
      function checkSession() {
        if (CURRENT_USER) {
          document.getElementById("login-screen").style.display = "none";
          document.getElementById("dashboard-screen").style.display = "block";
          document.getElementById("display-user").innerText = CURRENT_USER;
          fetchData(); // Load data user ini
        } else {
          document.getElementById("login-screen").style.display = "flex";
          document.getElementById("dashboard-screen").style.display = "none";
        }
      }

      async function doLogin() {
        const user = document.getElementById("login-user").value;
        const pin = document.getElementById("login-pin").value;
        const btn = document.querySelector(".btn-login");
        const msg = document.getElementById("login-msg");

        if (!user || !pin) {
          msg.innerText = "Isi semua kolom!";
          return;
        }

        btn.innerText = "Mengecek...";
        btn.disabled = true;

        try {
          const res = await fetch(`${API_URL}?action=login&username=${user}&pin=${pin}`);
          const json = await res.json();

          if (json.result === "success") {
            localStorage.setItem("planner_user", json.username);
            CURRENT_USER = json.username;
            msg.innerText = "";
            checkSession();
          } else {
            msg.innerText = "Login Gagal: " + json.message;
          }
        } catch (e) {
          msg.innerText = "Error koneksi / Script URL salah.";
        } finally {
          btn.innerText = "Masuk";
          btn.disabled = false;
        }
      }

      function doLogout() {
        if (confirm("Yakin mau keluar?")) {
          localStorage.removeItem("planner_user");
          location.reload();
        }
      }

      // --- FETCH DATA ---
      async function fetchData() {
        try {
          const res = await fetch(`${API_URL}?action=read&username=${CURRENT_USER}`);
          const json = await res.json();
          globalTasks = json.data || [];
          renderTable(globalTasks);
        } catch (err) {
          console.error(err);
        }
      }

      // --- RENDER TABLE (VERSI GANTENG DIKEMBALIKAN!) ---
      function renderTable(tasks) {
        const tbody = document.getElementById("task-list");
        tbody.innerHTML = "";

        if (tasks.length === 0) {
          tbody.innerHTML = `<tr><td colspan="9" style="text-align:center; padding:40px; color:#666;">Belum ada data. Klik tombol <b>+ Tambah Konten</b> di atas!</td></tr>`;
          document.getElementById("progress-info").innerText = "0 Konten.";
          return;
        }

        const doneCount = tasks.filter((t) => t.done === true || t.status === "Published").length;
        document.getElementById("progress-info").innerHTML = `Progress: <b>${doneCount}</b> selesai dari <b>${tasks.length}</b> konten.`;

        tasks.forEach((task) => {
          const isFinished = task.status === "Published" || task.done === true;

          // Hitung Days Left
          const due = new Date(task.duedate);
          const today = new Date();
          due.setHours(0, 0, 0, 0);
          today.setHours(0, 0, 0, 0);
          const diffDays = Math.ceil((due - today) / (1000 * 60 * 60 * 24));

          let daysText = "";
          let daysClass = "";

          if (isFinished) {
            daysText = "Selesai ‚úÖ";
            daysClass = "days-done";
          } else {
            if (diffDays < 0) {
              daysText = `Telat ${Math.abs(diffDays)} hari`;
              daysClass = "days-late";
            } else if (diffDays === 0) {
              daysText = "HARI INI!";
              daysClass = "days-today";
            } else {
              daysText = `${diffDays} hari lagi`;
              daysClass = "days-ok";
            }
          }

          // Styling Kategori
          let catClass = "cat-default";
          const c = task.category ? task.category.toLowerCase() : "";
          if (c.includes("gadget")) catClass = "cat-gadget";
          else if (c.includes("vlog")) catClass = "cat-vlog";
          else if (c.includes("short")) catClass = "cat-shorts";
          else if (c.includes("brain")) catClass = "cat-brainstorm";

          // Styling Prioritas
          let prioClass = "prio-low";
          if (task.priority === "High") prioClass = "prio-high";
          if (task.priority === "Medium") prioClass = "prio-medium";

          const tr = document.createElement("tr");
          tr.innerHTML = `
                    <td>#${task.no}</td>
                    <td style="font-weight:600; font-size:1rem;">${task.task}</td>
                    <td><span class="badge ${catClass}">${task.category}</span></td>
                    <td><span class="${prioClass}">${task.priority}</span></td>
                    <td>${due.toLocaleDateString("id-ID", { day: "numeric", month: "short", year: "numeric" })}</td>
                    <td><span class="${daysClass}">${daysText}</span></td>
                    <td>
                        <select onchange="updateData(${task.no}, 'status', this.value)" style="padding:6px; border-radius:4px;">
                            <option value="Not Started" ${task.status === "Not Started" ? "selected" : ""}>Not Started</option>
                            <option value="Research" ${task.status === "Research" ? "selected" : ""}>Research</option>
                            <option value="Scripting" ${task.status === "Scripting" ? "selected" : ""}>Scripting</option>
                            <option value="In Review" ${task.status === "In Review" ? "selected" : ""}>In Review</option>
                            <option value="Scheduling" ${task.status === "Scheduling" ? "selected" : ""}>Scheduling</option>
                            <option value="Published" ${task.status === "Published" ? "selected" : ""}>Published</option>
                        </select>
                    </td>
                    <td style="text-align:center">
                        <input type="checkbox" ${isFinished ? "checked" : ""} onchange="updateData(${task.no}, 'done', this.checked)">
                    </td>
                    <td style="text-align:center; white-space:nowrap;">
                        <button class="btn-action btn-edit" onclick="openModal(${task.no})">‚úèÔ∏è</button>
                        <button class="btn-action btn-delete" onclick="deleteData(${task.no})">üóëÔ∏è</button>
                    </td>
                `;
          tbody.appendChild(tr);
        });
      }

      // --- UPDATE & DELETE ---
      async function updateData(id, type, val) {
        await fetch(`${API_URL}?action=update&no=${id}&username=${CURRENT_USER}&${type}=${val}`, { method: "POST" });
        if (type === "status" && val === "Published") fetchData(); // Refresh visual biar checklist otomatis nyala
        if (type === "done") fetchData(); // Refresh kalau checklist dicentang manual
      }

      async function deleteData(id) {
        if (confirm("Yakin mau hapus konten ini?")) {
          await fetch(`${API_URL}?action=delete&no=${id}&username=${CURRENT_USER}`, { method: "POST" });
          fetchData();
        }
      }

      // --- MODAL EDIT ---
      function openModal(id) {
        const task = globalTasks.find((t) => t.no == id);
        if (task) {
          document.getElementById("edit-id").value = task.no;
          document.getElementById("edit-task").value = task.task;
          document.getElementById("edit-category").value = task.category;
          document.getElementById("edit-priority").value = task.priority;
          document.getElementById("edit-duedate").value = task.duedate ? new Date(task.duedate).toISOString().split("T")[0] : "";
          document.getElementById("editModal").style.display = "flex";
        }
      }

      document.getElementById("editForm").addEventListener("submit", async function (e) {
        e.preventDefault();
        const btn = document.getElementById("btnSaveEdit");
        btn.innerText = "Menyimpan...";
        const id = document.getElementById("edit-id").value;
        const task = encodeURIComponent(document.getElementById("edit-task").value);
        const cat = encodeURIComponent(document.getElementById("edit-category").value);
        const prio = encodeURIComponent(document.getElementById("edit-priority").value);
        const date = encodeURIComponent(document.getElementById("edit-duedate").value);

        // Kirim username juga
        await fetch(`${API_URL}?action=update&no=${id}&username=${CURRENT_USER}&task=${task}&category=${cat}&priority=${prio}&duedate=${date}`, { method: "POST" });

        document.getElementById("editModal").style.display = "none";
        btn.innerText = "Simpan Perubahan";
        fetchData();
      });

      checkSession();
    </script>
  </body>
</html>
