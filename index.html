<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Planner Multi-User</title>
    <style>
      :root {
        --primary: #2563eb;
        --bg: #f3f4f6;
        --card: #ffffff;
        --text: #1f2937;
        --border: #e5e7eb;
        --success: #16a34a;
        --danger: #dc2626;
      }
      body {
        font-family: "Segoe UI", sans-serif;
        background: var(--bg);
        color: var(--text);
        margin: 0;
        padding: 20px;
      }

      /* LOGIN SCREEN STYLE */
      #login-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: var(--bg);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
      }
      .login-card {
        background: white;
        padding: 40px;
        border-radius: 12px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        width: 100%;
        max-width: 350px;
        text-align: center;
      }
      .login-card h2 {
        margin-top: 0;
        color: var(--primary);
      }
      .login-card input {
        width: 100%;
        padding: 12px;
        margin-bottom: 15px;
        border: 1px solid #ddd;
        border-radius: 8px;
        box-sizing: border-box;
        font-size: 1rem;
      }
      .btn-login {
        background: var(--primary);
        color: white;
        width: 100%;
        padding: 12px;
        border: none;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
        font-size: 1rem;
      }
      .btn-login:hover {
        background: #1d4ed8;
      }

      /* DASHBOARD STYLE (Hidden by default) */
      #dashboard-screen {
        display: none;
      }

      .header {
        background: var(--primary);
        color: white;
        padding: 1.5rem;
        border-radius: 12px;
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .header h1 {
        margin: 0;
        font-size: 1.5rem;
      }
      .user-badge {
        background: rgba(255, 255, 255, 0.2);
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 0.8rem;
        margin-left: 10px;
      }

      .btn-add {
        background: white;
        color: var(--primary);
        padding: 10px 20px;
        text-decoration: none;
        border-radius: 8px;
        font-weight: 700;
        cursor: pointer;
        border: none;
      }
      .btn-logout {
        background: transparent;
        border: 1px solid white;
        color: white;
        padding: 8px 15px;
        border-radius: 6px;
        cursor: pointer;
        margin-left: 10px;
        font-size: 0.8rem;
      }
      .btn-logout:hover {
        background: rgba(255, 255, 255, 0.1);
      }

      /* TABEL STYLE (Sama kayak sebelumnya) */
      .table-wrap {
        overflow-x: auto;
        background: var(--card);
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }
      table {
        width: 100%;
        border-collapse: collapse;
        min-width: 900px;
      }
      th {
        background: #f8fafc;
        text-align: left;
        padding: 16px;
        border-bottom: 2px solid var(--border);
      }
      td {
        padding: 14px 16px;
        border-bottom: 1px solid var(--border);
        vertical-align: middle;
      }

      .badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        display: inline-block;
        white-space: nowrap;
      }
      .cat-gadget {
        background: #dbeafe;
        color: #1e40af;
      }
      .cat-vlog {
        background: #fef9c3;
        color: #854d0e;
      }
      .cat-shorts {
        background: #fee2e2;
        color: #991b1b;
      }
      .cat-brainstorm {
        background: #d1fae5;
        color: #065f46;
      }

      .days-late {
        color: var(--danger);
        font-weight: 800;
        background: #fee2e2;
        padding: 4px 8px;
        border-radius: 6px;
      }
      .days-done {
        color: var(--success);
        font-weight: 700;
        background: #dcfce7;
        padding: 4px 10px;
        border-radius: 6px;
      }

      .btn-action {
        padding: 6px 10px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        margin-right: 5px;
      }
      .btn-edit {
        background: #f3f4f6;
        border: 1px solid #d1d5db;
      }
      .btn-delete {
        background: #fee2e2;
        color: var(--danger);
        border: 1px solid #fca5a5;
      }

      /* MODAL STYLE */
      .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }
      .modal-card {
        background: white;
        padding: 25px;
        border-radius: 12px;
        width: 100%;
        max-width: 400px;
      }
      .form-control {
        width: 100%;
        padding: 10px;
        margin-bottom: 10px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        box-sizing: border-box;
      }
      .btn-submit {
        background: var(--primary);
        color: white;
        width: 100%;
        padding: 10px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
      }
      .btn-cancel {
        background: transparent;
        width: 100%;
        padding: 10px;
        border: none;
        cursor: pointer;
        color: #666;
      }
    </style>
  </head>
  <body>
    <div id="login-screen">
      <div class="login-card">
        <h2>üîê Login Planner</h2>
        <p style="color: #666; font-size: 0.9rem; margin-bottom: 20px">Masukkan Nama & PIN Anda</p>
        <input type="text" id="login-user" placeholder="Username (misal: Andri)" required />
        <input type="password" id="login-pin" placeholder="PIN (misal: 1234)" required />
        <button class="btn-login" onclick="doLogin()">Masuk</button>
        <p id="login-msg" style="color: red; margin-top: 10px; font-size: 0.9rem"></p>
      </div>
    </div>

    <div id="dashboard-screen">
      <div class="header">
        <div>
          <h1>üöÄ Dashboard <span id="display-user" class="user-badge"></span></h1>
          <p id="progress-info">Memuat data...</p>
        </div>
        <div style="display: flex; align-items: center">
          <a href="add.html" class="btn-add">+ Tambah</a>
          <button class="btn-logout" onclick="doLogout()">Keluar</button>
        </div>
      </div>

      <div class="table-wrap">
        <table id="main-table">
          <thead>
            <tr>
              <th>Task Name</th>
              <th>Category</th>
              <th>Due Date</th>
              <th>Status</th>
              <th>Done</th>
              <th>Aksi</th>
            </tr>
          </thead>
          <tbody id="task-list"></tbody>
        </table>
      </div>
    </div>

    <div class="modal-overlay" id="editModal">
      <div class="modal-card">
        <h3>‚úèÔ∏è Edit Konten</h3>
        <form id="editForm">
          <input type="hidden" id="edit-id" />
          <input type="text" id="edit-task" class="form-control" placeholder="Judul" />
          <select id="edit-category" class="form-control">
            <option value="YT Gadget">YT Gadget</option>
            <option value="YT Vlog">YT Vlog</option>
            <option value="Shorts">Shorts</option>
            <option value="Brainstorm">Brainstorm</option>
          </select>
          <input type="date" id="edit-duedate" class="form-control" />
          <button type="submit" class="btn-submit" id="btnSaveEdit">Simpan</button>
          <button type="button" class="btn-cancel" onclick="document.getElementById('editModal').style.display='none'">Batal</button>
        </form>
      </div>
    </div>

    <script>
      // GANTI URL DI SINI
      const API_URL = "https://script.google.com/macros/s/AKfycbzUuN3e88CYwvlRYNGLsYsDxFXxFHC0ZyWE4vPenzkn9927tetWD2K1c52XBp0X9FD3zg/exec";

      let CURRENT_USER = localStorage.getItem("planner_user") || null;
      let globalTasks = [];

      // --- SISTEM LOGIN ---
      function checkSession() {
        if (CURRENT_USER) {
          document.getElementById("login-screen").style.display = "none";
          document.getElementById("dashboard-screen").style.display = "block";
          document.getElementById("display-user").innerText = CURRENT_USER;
          fetchData(); // Load data user ini
        } else {
          document.getElementById("login-screen").style.display = "flex";
          document.getElementById("dashboard-screen").style.display = "none";
        }
      }

      async function doLogin() {
        const user = document.getElementById("login-user").value;
        const pin = document.getElementById("login-pin").value;
        const btn = document.querySelector(".btn-login");
        const msg = document.getElementById("login-msg");

        if (!user || !pin) {
          msg.innerText = "Isi semua kolom!";
          return;
        }

        btn.innerText = "Mengecek...";
        btn.disabled = true;

        try {
          // Cek ke Database
          const res = await fetch(`${API_URL}?action=login&username=${user}&pin=${pin}`);
          const json = await res.json();

          if (json.result === "success") {
            localStorage.setItem("planner_user", json.username);
            CURRENT_USER = json.username;
            msg.innerText = "";
            checkSession();
          } else {
            msg.innerText = "Login Gagal: " + json.message;
          }
        } catch (e) {
          msg.innerText = "Error koneksi.";
        } finally {
          btn.innerText = "Masuk";
          btn.disabled = false;
        }
      }

      function doLogout() {
        if (confirm("Yakin mau keluar?")) {
          localStorage.removeItem("planner_user");
          location.reload();
        }
      }

      // --- CRUD DATA (Ditambah param username) ---
      async function fetchData() {
        try {
          const res = await fetch(`${API_URL}?action=read&username=${CURRENT_USER}`);
          const json = await res.json();
          globalTasks = json.data || [];
          renderTable(globalTasks);
        } catch (err) {
          console.error(err);
        }
      }

      // Fungsi Render Table (Disederhanakan untuk ringkas)
      function renderTable(tasks) {
        const tbody = document.getElementById("task-list");
        tbody.innerHTML = "";

        if (tasks.length === 0) {
          tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding:20px;">Belum ada data. Klik Tambah!</td></tr>`;
          return;
        }

        tasks.forEach((task) => {
          const isFinished = task.status === "Published" || task.done === true;
          const due = new Date(task.duedate);
          const today = new Date();
          due.setHours(0, 0, 0, 0);
          today.setHours(0, 0, 0, 0);
          const diff = Math.ceil((due - today) / 86400000);

          let daysHtml = isFinished ? `<span class="badge" style="background:#dcfce7; color:#16a34a">Selesai ‚úÖ</span>` : diff < 0 ? `<span class="badge days-late">Telat ${Math.abs(diff)} hari</span>` : `${diff} hari lagi`;

          const tr = document.createElement("tr");
          tr.innerHTML = `
                    <td style="font-weight:600">${task.task}</td>
                    <td><span class="badge cat-${task.category.toLowerCase().split(" ")[0]}">${task.category}</span></td>
                    <td>${due.toLocaleDateString("id-ID")} <br> ${daysHtml}</td>
                    <td>
                        <select onchange="updateData(${task.no}, 'status', this.value)" style="padding:5px;">
                            <option value="Not Started" ${task.status === "Not Started" ? "selected" : ""}>Draft</option>
                            <option value="Published" ${task.status === "Published" ? "selected" : ""}>Published</option>
                        </select>
                    </td>
                    <td style="text-align:center">
                        <input type="checkbox" ${task.done ? "checked" : ""} onchange="updateData(${task.no}, 'done', this.checked)">
                    </td>
                    <td>
                        <button class="btn-action btn-edit" onclick="openModal(${task.no})">‚úèÔ∏è</button>
                        <button class="btn-action btn-delete" onclick="deleteData(${task.no})">üóëÔ∏è</button>
                    </td>
                `;
          tbody.appendChild(tr);
        });
        document.getElementById("progress-info").innerText = `${tasks.length} Konten ditemukan.`;
      }

      // --- FUNGSI UPDATE & DELETE ---
      async function updateData(id, type, val) {
        // Kirim username juga biar aman
        await fetch(`${API_URL}?action=update&no=${id}&username=${CURRENT_USER}&${type}=${val}`, { method: "POST" });
        if (type === "status" && val === "Published") fetchData(); // Refresh visual
      }

      async function deleteData(id) {
        if (confirm("Hapus?")) {
          await fetch(`${API_URL}?action=delete&no=${id}&username=${CURRENT_USER}`, { method: "POST" });
          fetchData();
        }
      }

      // --- MODAL EDIT ---
      function openModal(id) {
        const task = globalTasks.find((t) => t.no == id);
        if (task) {
          document.getElementById("edit-id").value = task.no;
          document.getElementById("edit-task").value = task.task;
          document.getElementById("edit-category").value = task.category;
          document.getElementById("edit-duedate").value = task.duedate ? new Date(task.duedate).toISOString().split("T")[0] : "";
          document.getElementById("editModal").style.display = "flex";
        }
      }

      document.getElementById("editForm").addEventListener("submit", async function (e) {
        e.preventDefault();
        const btn = document.getElementById("btnSaveEdit");
        btn.innerText = "Menyimpan...";
        const id = document.getElementById("edit-id").value;
        const task = encodeURIComponent(document.getElementById("edit-task").value);
        const cat = encodeURIComponent(document.getElementById("edit-category").value);
        const date = encodeURIComponent(document.getElementById("edit-duedate").value);

        await fetch(`${API_URL}?action=update&no=${id}&username=${CURRENT_USER}&task=${task}&category=${cat}&duedate=${date}`, { method: "POST" });

        document.getElementById("editModal").style.display = "none";
        btn.innerText = "Simpan";
        fetchData();
      });

      // Jalankan Cek Sesi saat awal buka
      checkSession();
    </script>
  </body>
</html>
