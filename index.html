<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Planner Multi-User</title>
    <style>
      :root {
        --primary: #2563eb;
        --bg: #f3f4f6;
        --card: #ffffff;
        --text: #1f2937;
        --border: #e5e7eb;
        --success: #16a34a;
        --danger: #dc2626;
      }
      body {
        font-family: "Segoe UI", sans-serif;
        background: var(--bg);
        color: var(--text);
        margin: 0;
        padding: 20px;
      }

      /* LOGIN & LAYOUT STYLE (SAMA) */
      #login-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: var(--bg);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
      }
      .login-card {
        background: white;
        padding: 40px;
        border-radius: 12px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        width: 100%;
        max-width: 350px;
        text-align: center;
      }
      .login-card input {
        width: 100%;
        padding: 12px;
        margin-bottom: 15px;
        border: 1px solid #ddd;
        border-radius: 8px;
        box-sizing: border-box;
        font-size: 1rem;
      }
      .btn-login {
        background: var(--primary);
        color: white;
        width: 100%;
        padding: 12px;
        border: none;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
        font-size: 1rem;
        transition: 0.2s;
      }
      .btn-login:hover {
        background: #1d4ed8;
      }
      .toggle-link {
        display: block;
        margin-top: 15px;
        font-size: 0.9rem;
        color: #666;
        cursor: pointer;
        text-decoration: underline;
      }

      #dashboard-screen {
        display: none;
      }
      .header {
        background: var(--primary);
        color: white;
        padding: 1.5rem;
        border-radius: 12px;
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      }
      .header h1 {
        margin: 0;
        font-size: 1.5rem;
      }
      .user-badge {
        background: rgba(255, 255, 255, 0.2);
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.9rem;
        margin-left: 10px;
        font-weight: bold;
      }

      .btn-add {
        background: white;
        color: var(--primary);
        padding: 10px 20px;
        text-decoration: none;
        border-radius: 8px;
        font-weight: 700;
        cursor: pointer;
        border: none;
        transition: 0.2s;
      }
      .btn-logout {
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.5);
        color: white;
        padding: 9px 15px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.9rem;
        margin-left: 10px;
      }
      /* --- TOMBOL DONASI --- */
      .btn-donate {
        background: #f59e0b; /* Warna orange a la Saweria */
        color: white;
        padding: 10px 15px;
        text-decoration: none;
        border-radius: 8px;
        font-weight: 700;
        font-size: 0.9rem;
        transition: all 0.2s ease;
        border: 1px solid #d97706;
      }
      .btn-donate:hover {
        background: #d97706;
        transform: translateY(-2px); /* Efek melayang pas disentuh */
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
      }

      .table-wrap {
        overflow-x: auto;
        background: var(--card);
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }
      table {
        width: 100%;
        border-collapse: collapse;
        min-width: 1100px;
      }
      th {
        background: #f8fafc;
        text-align: left;
        padding: 16px;
        border-bottom: 2px solid var(--border);
        font-weight: 600;
        color: #64748b;
      }
      td {
        padding: 14px 16px;
        border-bottom: 1px solid var(--border);
        vertical-align: middle;
        font-size: 0.95rem;
      }
      tr:hover {
        background-color: #f8fafc;
      }

      /* BADGE UMUM */
      .badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        display: inline-block;
        white-space: nowrap;
        letter-spacing: 0.5px;
      }

      /* PALET WARNA DINAMIS (Ini Rahasianya!) */
      .color-1 {
        background: #dbeafe;
        color: #1e40af;
      } /* Biru */
      .color-2 {
        background: #fef9c3;
        color: #854d0e;
      } /* Kuning */
      .color-3 {
        background: #fee2e2;
        color: #991b1b;
      } /* Merah */
      .color-4 {
        background: #d1fae5;
        color: #065f46;
      } /* Hijau */
      .color-5 {
        background: #f3e8ff;
        color: #6b21a8;
      } /* Ungu */
      .color-6 {
        background: #ffedd5;
        color: #9a3412;
      } /* Orange */
      .color-0 {
        background: #f3f4f6;
        color: #4b5563;
      } /* Abu (Default) */

      .prio-high {
        color: var(--danger);
        font-weight: 700;
      }
      .prio-medium {
        color: #d97706;
        font-weight: 600;
      }
      .prio-low {
        color: var(--success);
        font-weight: 600;
      }

      .days-late {
        color: var(--danger);
        font-weight: 800;
        background: #fee2e2;
        padding: 4px 8px;
        border-radius: 6px;
        white-space: nowrap;
      }
      .days-done {
        color: var(--success);
        font-weight: 700;
        background: #dcfce7;
        padding: 4px 10px;
        border-radius: 6px;
        white-space: nowrap;
        border: 1px solid #bbf7d0;
      }

      select,
      input[list] {
        padding: 8px;
        border: 1px solid var(--border);
        border-radius: 6px;
        background: white;
        font-size: 0.9rem;
        cursor: pointer;
      }
      input[type="checkbox"] {
        width: 20px;
        height: 20px;
        cursor: pointer;
        accent-color: var(--success);
      }

      .btn-action {
        padding: 8px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        margin-right: 5px;
        transition: all 0.2s;
      }
      .btn-edit {
        background: #f3f4f6;
        border: 1px solid #d1d5db;
        color: #374151;
      }
      .btn-delete {
        background: #fee2e2;
        color: #dc2626;
        border: 1px solid #fca5a5;
      }

      /* MODAL */
      .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }
      .modal-card {
        background: white;
        padding: 30px;
        border-radius: 12px;
        width: 100%;
        max-width: 400px;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
      }
      .form-group {
        margin-bottom: 15px;
      }
      .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        color: #374151;
      }
      .form-control {
        width: 100%;
        padding: 10px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        box-sizing: border-box;
        font-size: 1rem;
      }
      .btn-submit {
        background: var(--primary);
        color: white;
        width: 100%;
        padding: 12px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
      }
      .btn-cancel {
        background: transparent;
        width: 100%;
        padding: 10px;
        border: none;
        cursor: pointer;
        color: #6b7280;
        margin-top: 5px;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: #6b7280;
        font-style: italic;
      }
    </style>
  </head>
  <body>
    <div id="login-screen">
      <div class="login-card">
        <h2 id="login-title">üîê Login Planner</h2>
        <p style="color: #666; font-size: 0.9rem; margin-bottom: 20px">Masukkan Nama & PIN Anda</p>
        <input type="text" id="login-user" placeholder="Username (misal: Andri)" required />
        <input type="password" id="login-pin" placeholder="PIN (misal: 1234)" required />
        <button class="btn-login" id="btn-login-action" onclick="doLogin()">Masuk</button>
        <p id="login-msg" style="color: red; margin-top: 10px; font-size: 0.9rem"></p>
        <span class="toggle-link" id="toggle-text" onclick="switchMode()">Belum punya akun? Daftar</span>
      </div>
    </div>

    <div id="dashboard-screen">
      <div class="header">
        <div>
          <h1>üöÄ Dashboard <span id="display-user" class="user-badge"></span></h1>
          <p id="progress-info">Memuat data...</p>
        </div>
        <div style="display: flex; align-items: center; gap: 15px">
          <a href="https://saweria.co/username_lo" target="_blank" class="btn-donate">‚òï Traktir Kopi</a>

          <a href="add.html" class="btn-add">+ Tambah Konten</a>
          <button class="btn-logout" onclick="doLogout()">Keluar</button>
        </div>
      </div>

      <div class="table-wrap">
        <table id="main-table">
          <thead>
            <tr>
              <th width="5%">No</th>
              <th width="20%">Task Name</th>
              <th width="15%">Category</th>
              <th width="10%">Priority</th>
              <th width="12%">Due Date</th>
              <th width="12%">Days Left</th>
              <th width="12%">Status</th>
              <th width="5%" style="text-align: center">Done</th>
              <th width="10%" style="text-align: center">Aksi</th>
            </tr>
          </thead>
          <tbody id="task-list">
            <tr>
              <td colspan="9" class="loading">Sedang mengambil data...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="modal-overlay" id="editModal">
      <div class="modal-card">
        <h3 style="margin-top: 0">‚úèÔ∏è Edit Konten</h3>
        <form id="editForm">
          <input type="hidden" id="edit-id" />
          <div class="form-group">
            <label>Judul Task</label>
            <input type="text" id="edit-task" class="form-control" placeholder="Judul" required />
          </div>
          <div class="form-group">
            <label>Kategori (Ketik baru / Pilih)</label>
            <input type="text" id="edit-category" list="category-options" class="form-control" placeholder="Ketik kategori..." required />
            <datalist id="category-options"> </datalist>
          </div>
          <div class="form-group">
            <label>Prioritas</label>
            <select id="edit-priority" class="form-control">
              <option value="High">High üî•</option>
              <option value="Medium">Medium ‚ö†Ô∏è</option>
              <option value="Low">Low ‚òòÔ∏è</option>
            </select>
          </div>
          <div class="form-group">
            <label>Due Date</label>
            <input type="date" id="edit-duedate" class="form-control" required />
          </div>
          <button type="submit" class="btn-submit" id="btnSaveEdit">Simpan Perubahan</button>
          <button type="button" class="btn-cancel" onclick="document.getElementById('editModal').style.display='none'">Batal</button>
        </form>
      </div>
    </div>

    <script>
      const API_URL = "https://script.google.com/macros/s/AKfycbzUuN3e88CYwvlRYNGLsYsDxFXxFHC0ZyWE4vPenzkn9927tetWD2K1c52XBp0X9FD3zg/exec";

      let CURRENT_USER = localStorage.getItem("planner_user") || null;
      let globalTasks = [];
      let isRegisterMode = false;

      // --- LOGIN & REGISTER ---
      function checkSession() {
        if (CURRENT_USER) {
          document.getElementById("login-screen").style.display = "none";
          document.getElementById("dashboard-screen").style.display = "block";
          document.getElementById("display-user").innerText = CURRENT_USER;
          fetchData();
        } else {
          document.getElementById("login-screen").style.display = "flex";
          document.getElementById("dashboard-screen").style.display = "none";
        }
      }

      function switchMode() {
        isRegisterMode = !isRegisterMode;
        const title = document.getElementById("login-title");
        const btn = document.getElementById("btn-login-action");
        const toggle = document.getElementById("toggle-text");
        const msg = document.getElementById("login-msg");
        msg.innerText = "";

        if (isRegisterMode) {
          title.innerText = "üìù Daftar Akun Baru";
          btn.innerText = "Daftar Sekarang";
          btn.onclick = doRegister;
          toggle.innerText = "Sudah punya akun? Login";
        } else {
          title.innerText = "üîê Login Planner";
          btn.innerText = "Masuk";
          btn.onclick = doLogin;
          toggle.innerText = "Belum punya akun? Daftar";
        }
      }

      async function doLogin() {
        const user = document.getElementById("login-user").value;
        const pin = document.getElementById("login-pin").value;
        const btn = document.getElementById("btn-login-action");
        const msg = document.getElementById("login-msg");

        if (!user || !pin) {
          msg.innerText = "Isi semua kolom!";
          return;
        }
        btn.innerText = "Mengecek...";
        btn.disabled = true;

        try {
          const res = await fetch(`${API_URL}?action=login&username=${user}&pin=${pin}`);
          const json = await res.json();
          if (json.result === "success") {
            localStorage.setItem("planner_user", json.username);
            CURRENT_USER = json.username;
            msg.innerText = "";
            checkSession();
          } else {
            msg.innerText = "Gagal: " + json.message;
          }
        } catch (e) {
          msg.innerText = "Error koneksi.";
        } finally {
          // Cuma reset tombol kalau gagal login
          if (!CURRENT_USER) {
            btn.innerText = "Masuk";
            btn.disabled = false;
          }
        }
      }

      async function doRegister() {
        const user = document.getElementById("login-user").value;
        const pin = document.getElementById("login-pin").value;
        const btn = document.getElementById("btn-login-action");
        const msg = document.getElementById("login-msg");

        if (!user || !pin) {
          msg.innerText = "Isi semua kolom!";
          return;
        }
        btn.innerText = "Mendaftarkan...";
        btn.disabled = true;

        try {
          const res = await fetch(`${API_URL}?action=register&username=${user}&pin=${pin}`);
          const json = await res.json();
          if (json.result === "success") {
            alert("Pendaftaran Berhasil! Silakan Login.");
            switchMode(); // Otomatis balik ke form Login yang bener
          } else {
            msg.innerText = "Gagal: " + json.message;
            btn.innerText = "Daftar Sekarang";
            btn.disabled = false;
          }
        } catch (e) {
          msg.innerText = "Error koneksi.";
          btn.innerText = "Daftar Sekarang";
          btn.disabled = false;
        }
      }
      function doLogout() {
        if (confirm("Yakin mau keluar?")) {
          localStorage.removeItem("planner_user");
          location.reload();
        }
      }

      // --- FETCH DATA & RENDER ---
      async function fetchData() {
        try {
          const res = await fetch(`${API_URL}?action=read&username=${CURRENT_USER}`);
          const json = await res.json();
          globalTasks = json.data || [];
          renderTable(globalTasks);
          updateCategoryList(globalTasks); // Update opsi kategori
        } catch (err) {
          console.error(err);
        }
      }

      function renderTable(tasks) {
        const tbody = document.getElementById("task-list");
        tbody.innerHTML = "";

        if (tasks.length === 0) {
          tbody.innerHTML = `<tr><td colspan="9" style="text-align:center; padding:40px; color:#666;">Belum ada data.</td></tr>`;
          document.getElementById("progress-info").innerText = "0 Konten.";
          return;
        }

        const doneCount = tasks.filter((t) => t.done === true || t.status === "Published").length;
        document.getElementById("progress-info").innerHTML = `Progress: <b>${doneCount}</b> selesai dari <b>${tasks.length}</b> konten.`;

        tasks.forEach((task) => {
          const isFinished = task.status === "Published" || task.done === true;
          const due = new Date(task.duedate);
          const today = new Date();
          due.setHours(0, 0, 0, 0);
          today.setHours(0, 0, 0, 0);
          const diffDays = Math.ceil((due - today) / (1000 * 60 * 60 * 24));

          let daysText = isFinished ? "Selesai ‚úÖ" : diffDays < 0 ? `Telat ${Math.abs(diffDays)} hari` : diffDays === 0 ? "HARI INI!" : `${diffDays} hari lagi`;
          let daysClass = isFinished ? "days-done" : diffDays < 0 ? "days-late" : diffDays === 0 ? "days-today" : "days-ok";

          // --- LOGIKA WARNA KATEGORI OTOMATIS ---
          // Kita generate angka dari huruf pertama kategori biar warnanya konsisten
          // Misal: "Masak" selalu warna 1, "Vlog" selalu warna 2
          let catClass = "color-0";
          if (task.category) {
            const firstChar = task.category.charCodeAt(0);
            const colorIndex = (firstChar % 6) + 1; // Pilih warna 1-6
            catClass = `color-${colorIndex}`;
          }

          let prioClass = task.priority === "High" ? "prio-high" : task.priority === "Medium" ? "prio-medium" : "prio-low";

          const tr = document.createElement("tr");
          tr.innerHTML = `
                    <td>#${task.no}</td>
                    <td style="font-weight:600;">${task.task}</td>
                    <td><span class="badge ${catClass}">${task.category}</span></td>
                    <td><span class="${prioClass}">${task.priority}</span></td>
                    <td>${due.toLocaleDateString("id-ID")}</td>
                    <td><span class="${daysClass}">${daysText}</span></td>
                    <td>
                        <select onchange="updateData(${task.no}, 'status', this.value)">
                            <option value="Not Started" ${task.status === "Not Started" ? "selected" : ""}>Not Started</option>
                            <option value="Published" ${task.status === "Published" ? "selected" : ""}>Published</option>
                            </select>
                    </td>
                    <td style="text-align:center"><input type="checkbox" ${isFinished ? "checked" : ""} onchange="updateData(${task.no}, 'done', this.checked)"></td>
                    <td style="text-align:center; white-space:nowrap;">
                        <button class="btn-action btn-edit" onclick="openModal(${task.no})">‚úèÔ∏è</button>
                        <button class="btn-action btn-delete" onclick="deleteData(${task.no})">üóëÔ∏è</button>
                    </td>
                `;
          tbody.appendChild(tr);
        });
      }

      // --- ISI LIST KATEGORI DI MODAL EDIT ---
      function updateCategoryList(tasks) {
        // Ambil semua kategori unik yang pernah dipake user
        const categories = [...new Set(tasks.map((t) => t.category))];
        const datalist = document.getElementById("category-options");
        // Tambah kategori default biar gak kosong
        const defaults = ["YT Gadget", "YT Vlog", "Shorts", "Brainstorm"];
        const allCats = [...new Set([...defaults, ...categories])];

        datalist.innerHTML = allCats.map((c) => `<option value="${c}">`).join("");
      }

      // --- UPDATE & DELETE ---
      async function updateData(id, type, val) {
        await fetch(`${API_URL}?action=update&no=${id}&username=${CURRENT_USER}&${type}=${val}`, { method: "POST" });
        if (type === "status" && val === "Published") fetchData();
        if (type === "done") fetchData();
      }

      async function deleteData(id) {
        if (confirm("Hapus?")) {
          await fetch(`${API_URL}?action=delete&no=${id}&username=${CURRENT_USER}`, { method: "POST" });
          fetchData();
        }
      }

      // --- MODAL ---
      function openModal(id) {
        const task = globalTasks.find((t) => t.no == id);
        if (task) {
          document.getElementById("edit-id").value = task.no;
          document.getElementById("edit-task").value = task.task;
          document.getElementById("edit-category").value = task.category; // Input teks
          document.getElementById("edit-priority").value = task.priority;
          document.getElementById("edit-duedate").value = task.duedate ? new Date(task.duedate).toISOString().split("T")[0] : "";
          document.getElementById("editModal").style.display = "flex";
        }
      }

      document.getElementById("editForm").addEventListener("submit", async function (e) {
        e.preventDefault();
        const btn = document.getElementById("btnSaveEdit");
        btn.innerText = "Menyimpan...";

        const id = document.getElementById("edit-id").value;
        const task = encodeURIComponent(document.getElementById("edit-task").value);
        const cat = encodeURIComponent(document.getElementById("edit-category").value);
        const prio = encodeURIComponent(document.getElementById("edit-priority").value);
        const date = encodeURIComponent(document.getElementById("edit-duedate").value);

        await fetch(`${API_URL}?action=update&no=${id}&username=${CURRENT_USER}&task=${task}&category=${cat}&priority=${prio}&duedate=${date}`, { method: "POST" });

        document.getElementById("editModal").style.display = "none";
        btn.innerText = "Simpan Perubahan";
        fetchData();
      });

      checkSession();
    </script>
  </body>
</html>
